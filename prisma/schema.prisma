generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String            @id @default(uuid())
  phoneNumber            String            @unique
  email                  String?           @unique
  password               String?
  name                   String
  avatar                 String?
  location               String?
  bio                    String?
  trustScore             Int               @default(850)
  memberSince            String            @default("2025")
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  hasCompletedOnboarding Boolean           @default(false)
  otpCode                String?
  otpExpiresAt           DateTime?
  badges                 String[]
  stats                  Json?
  history                Json?
  role                   String            @default("user")
  isBanned               Boolean           @default(false)
  auditLogs              AuditLog[]
  createdCircles         Circle[]          @relation("CreatedCircles")
  ledgerActions          UserLedgerEntry[] @relation("AdminLedger")
  ledgerEntries          UserLedgerEntry[] @relation("UserLedger")
  memberships            Member[]
  supportCasesAssigned   SupportCase[]     @relation("AssignedCases")
  supportCasesCreated    SupportCase[]     @relation("CreatedCases")
}

model AuditLog {
  id         String   @id @default(uuid())
  adminId    String
  action     String
  targetType String
  targetId   String
  changes    Json?
  reason     String?
  timestamp  DateTime @default(now())
  admin      User     @relation(fields: [adminId], references: [id])
}

model SupportCase {
  id              String   @id @default(uuid())
  caseId          String   @unique @default(cuid())
  category        String
  priority        String
  status          String
  subject         String
  description     String?
  messages        Json?
  createdById     String
  assignedToId    String?
  relatedCircleId String?
  relatedUserId   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  assignedTo      User?    @relation("AssignedCases", fields: [assignedToId], references: [id])
  createdBy       User     @relation("CreatedCases", fields: [createdById], references: [id])
}

model NotificationLog {
  id           String   @id @default(uuid())
  type         String
  audience     Json
  title        String
  body         String
  sentAt       DateTime @default(now())
  sentByUserId String
}

model Circle {
  id             String               @id @default(uuid())
  name           String
  category       String
  amount         Float
  frequency      String
  duration       Int
  maxMembers     Int
  payoutTotal    Float
  startDate      DateTime
  description    String?
  rules          String[]
  coverImage     String?
  isPrivate      Boolean              @default(false)
  isFrozen       Boolean              @default(false)
  status         String
  currentRound   Int                  @default(1)
  pausedAt       DateTime?
  pauseReason    String?
  payoutSchedule Json?
  settings       Json?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  adminId        String
  admin          User                 @relation("CreatedCircles", fields: [adminId], references: [id])
  announcements  CircleAnnouncement[]
  events         CircleEvent[]
  ledgerEntries  UserLedgerEntry[]
  members        Member[]
}

model Member {
  id               String    @id @default(uuid())
  joinedAt         DateTime  @default(now())
  role             String
  payoutMonth      Int?
  payoutPreference String?
  status           String
  graceApplied     Boolean   @default(false)
  graceReason      String?
  dueDateExtension DateTime?
  userId           String
  circleId         String
  circle           Circle    @relation(fields: [circleId], references: [id])
  user             User      @relation(fields: [userId], references: [id])

  @@unique([userId, circleId])
}

model CircleEvent {
  id        String   @id @default(uuid())
  type      String
  message   String
  timestamp DateTime @default(now())
  meta      Json?
  circleId  String
  circle    Circle   @relation(fields: [circleId], references: [id])
}

model CircleAnnouncement {
  id          String   @id @default(uuid())
  title       String
  body        String
  isPinned    Boolean  @default(false)
  createdAt   DateTime @default(now())
  circleId    String
  createdById String
  circle      Circle   @relation(fields: [circleId], references: [id])
}

model UserLedgerEntry {
  id          String               @id @default(cuid())
  circleId    String?
  userId      String?
  adminId     String?
  type        LedgerEntryType
  direction   LedgerEntryDirection
  amount      Float?
  currency    String               @default("USD")
  description String?
  metadata    Json?
  createdAt   DateTime             @default(now())
  status      LedgerEntryStatus    @default(POSTED)
  admin       User?                @relation("AdminLedger", fields: [adminId], references: [id])
  circle      Circle?              @relation(fields: [circleId], references: [id])
  user        User?                @relation("UserLedger", fields: [userId], references: [id])

  @@index([circleId])
  @@index([userId])
  @@index([type])
  @@map("LedgerEntry")
}

enum LedgerEntryType {
  CONTRIBUTION_OBLIGATION_CREATED
  CONTRIBUTION_MARKED_PAID
  CONTRIBUTION_CONFIRMED
  CONTRIBUTION_MARKED_UNPAID
  CONTRIBUTION_OVERDUE_FLAGGED
  PAYOUT_RECIPIENT_ASSIGNED
  PAYOUT_MARKED_SENT
  PAYOUT_ACKNOWLEDGED
  MEMBER_JOINED
  MEMBER_REMOVED
  CIRCLE_PAUSED
  CIRCLE_RESUMED
  CORRECTION_ENTRY_POSTED
  PAYOUT_DISTRIBUTED
  CONTRIBUTION_REJECTED
  CIRCLE_STARTED
  GRACE_APPLIED
  DUE_DATE_EXTENDED
  ADMIN_ANNOUNCEMENT_SENT
  ADMIN_REMINDER_SENT
  SUPPORT_CASE_OPENED
}

enum LedgerEntryDirection {
  DEBIT
  CREDIT
  NEUTRAL
}

enum LedgerEntryStatus {
  POSTED
  VOIDED
}
